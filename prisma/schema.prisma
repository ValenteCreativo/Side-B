// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Note: Using PostgreSQL for production (Vercel)
// For local development with SQLite, use: provider = "sqlite"

model User {
  id            String    @id @default(cuid())
  walletAddress String    @unique
  role          String    @default("MUSICIAN") // "MUSICIAN" | "CREATOR"
  displayName   String?
  bio           String?
  avatarUrl     String?
  twitter       String?
  instagram     String?
  website       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt

  // Relations
  sessions      Session[]
  collections   Collection[]
  licenses      License[]    @relation("UserLicenses")

  // Social features
  followers     Follow[]     @relation("Following")
  following     Follow[]     @relation("Followers")

  // Notifications
  notifications Notification[]
}

model Collection {
  id          String    @id @default(cuid())
  ownerId     String
  owner       User      @relation(fields: [ownerId], references: [id])
  title       String
  description String?
  createdAt   DateTime  @default(now())

  // Relations
  sessions    Session[]
}

model Session {
  id           String      @id @default(cuid())
  ownerId      String
  owner        User        @relation(fields: [ownerId], references: [id])
  collectionId String?
  collection   Collection? @relation(fields: [collectionId], references: [id])

  // Session details
  title        String
  description  String
  contentType  String      // "JAM" | "REHEARSAL" | "PRODUCED"
  moodTags     String      // JSON string array for SQLite compatibility
  durationSec  Int?
  audioUrl     String
  priceUsd     Float

  // Story Protocol IP registration
  storyAssetId String?     // IP Asset ID from Story Protocol
  storyTxHash  String?     // Transaction hash of IP registration

  createdAt    DateTime    @default(now())

  // Relations
  licenses     License[]
}

model License {
  id        String   @id @default(cuid())
  sessionId String
  session   Session  @relation(fields: [sessionId], references: [id])
  buyerId   String
  buyer     User     @relation("UserLicenses", fields: [buyerId], references: [id])

  // License details
  createdAt DateTime @default(now())
  txHash    String?  // Transaction hash for on-chain license (future)

  @@unique([sessionId, buyerId]) // Prevent duplicate licenses
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower    User @relation("Followers", fields: [followerId], references: [id])
  following   User @relation("Following", fields: [followingId], references: [id])

  @@unique([followerId, followingId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String   // User receiving the notification
  type      String   // "PURCHASE" | "FOLLOW" | "MESSAGE"
  title     String
  message   String
  read      Boolean  @default(false)
  link      String?  // Optional link to relevant page
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
}
